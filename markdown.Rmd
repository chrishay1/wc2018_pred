---
title: "Monte carlo modelling of the FIFA World Cup"
author: "Christopher Hay"
date: "24 May 2018"
output: html_document
---
<base target="_blank"/>
```{r echo=FALSE,warning=FALSE,message=FALSE}
##PREDICTIVE MODELLING FOR THE 2018 WORLD CUP 
##read some data from the eloratings.net website
##rvest seems to be a package that may be of some use in reading the data
##install.packages("rvest")
library(rvest)
library(jsonlite)
library(tidyverse)
library(knitr)


##read in the file. This was downloaded from a ranking website late May 2018 (see R markdown)
wc_results3 <- read.csv("C:/Users/pc/Documents/Data science/World cup 2018/wc_results.csv")
wc_results3 <- wc_results3[,-1]
wc_results_x <- wc_results3[,c("team_two","team_one","score_two","score_one","rank_team_two",
                               "conf_team_two","rank_team_one","conf_team_one","year",
                               "host_region","home_cont_two","home_cont_one","team_two_win",
                               "team_one_win","draw")]

colnames(wc_results_x) <- colnames(wc_results3)
wc_results4 <- rbind(wc_results3,wc_results_x)
wc_results4$rating_diff_amt <- wc_results4$rank_team_one - wc_results4$rank_team_two

wc_results4$rating_diff_percent <- wc_results4$rank_team_one / wc_results4$rank_team_two




##a flag to say whether both teams are either home or away 
wc_results4$home_stus <- ""
wc_results4$home_stus[wc_results4$home_cont_one==1&wc_results4$home_cont_two==1] <-"both home"

wc_results4$home_stus[wc_results4$home_cont_one==1&wc_results4$home_cont_two==0] <- "home v away"
wc_results4$home_stus[wc_results4$home_cont_one==0&wc_results4$home_cont_two==1] <-"away v home"
wc_results4$home_stus[wc_results4$home_cont_one==0&wc_results4$home_cont_two==0]<- "away v away"
                            
wc_results4$result <- ""
for( i in 1:nrow(wc_results4)){
    wc_results4$result[i] <-if(wc_results4$score_one[i] >wc_results4$score_two[i]) {("win")}
    else if (wc_results4$score_one[i] ==wc_results4$score_two[i]){("draw")}
    else {("loss")}
    
}    
```
 

### Introduction

The <a href="http://en.wikipedia.org/wiki/2018_FIFA_World_Cup"> 2018 FIFA World Cup</a> is a football tournament starting on 14 June 2018 in Russia. This document describes the process I have taken to develop a model for determining the outcome of a match at this tournament, based on historic data from previous World Cups. I then use this model to simulate the outcome of the tournament a number of times, in order to give a prediction of the most likely winners of the tournament, as well as other finishes (most likely finalists, semi-finalists etc). 

The results of the modelling were as follows. A more detailed discussion of the results can be found in the Results section.


###Results from historic tournaments
The results of all games from the tournaments held between 1978 - 2014 were downloaded from http://www.international-football.net/ . Ten world cups have been held over this period; this should represent enough games to build a model. I didn't want to delve too far into history out of a concern that the game may have changed such that the results are not informative for our purposes. Note that I haven't tested this assumption!

World Cups consist of a group stage, and then a knockout bracket. During the group stage a game can be a draw; in the knockout stage extra time is played and then a penalty shoot-out takes place if the game is a draw. The source website lists results of knockout games after extra time is played, if needed, and then lists the game as a draw if a penalty shootout took place. The presence of the extra-time results could in theory lead to an under-representation of draws. In my modelling, I haven't treated knockout games differently, this could be a future step in the development of the model.

###Factors to include in the modelling
So now, I have a list of game results; in order to develop a model, I need some predictors. Intuitively, the main factor will be some measurement of team strength. FIFA maintain <a href="http://www.fifa.com/fifa-world-ranking/index.html"> their own rankings </a> which may suit our purposes but I have some suspicions over. In particular, these rankings have been used to seed the tournament, so some teams have structured their schedules to maximise this ranking, <a href="http://www.marca.com/en/football/international-football/2017/11/15/5a0cc44746163f2b218b464e.html">such as Poland</a>. If you'd wondered why group H looks a bit weak (Poland, Colombia, Senegal,Japan) now you know why!

This fairly candid Wikipedia page makes the claim that <a href="http://en.wikipedia.org/wiki/World_Football_Elo_Ratings"> an ELO rating performs better than the FIFA ranking system</a>. Therefore, I've used ELO rating of countries as a measure of a team's relative strength. Each team's ELO rating before the world cup has been downloaded from http://www.international-football.net/ , which in turn uses http://www.eloratings.net/ as it's source.

For the modelling, I've also captured each team's continental affiliation, and in which continent the tournament was played in. Note this is based on the team's current affiliation. So for instance Australia moving from OFC to AFC in the early 2000s is not reflected in the historic data; they are treated as being part of AFC for the analysis.

###Relationships of the factors

The below table lists the total win, loss and draw percentages within the data. Now each game is either a draw, or a win for either team; the underlying data lists one row for each game, so I have duplicated the data with the teams and scores swapped, so we have one row for each team and each game. 

<b>Table 1; overall results</b>
```{r overall,echo=FALSE,message=FALSE,warning=FALSE}

stus1 <- wc_results4  %>% summarise(count_all=n())

stus2 <- wc_results4 %>% filter(team_one_win==1) %>% summarise(count_wins=n())
stus3 <- wc_results4 %>% filter(draw==1) %>% summarise(count_draws=n())

stus <-  cbind(stus1,stus2) %>%  cbind (stus3) %>% replace_na(list(count_wins=0)) %>%
    mutate(win_pct = count_wins/count_all,draw_pct = count_draws/count_all,loss_pct = 1-win_pct-draw_pct)

stus$win_pct <- round(stus$win_pct,3)
stus$draw_pct <- round(stus$draw_pct,3)
stus$loss_pct <- round(stus$loss_pct,3)
stus$count_losses <- with(stus,count_all-count_draws-count_wins)

stus <- stus[,c("win_pct","draw_pct","loss_pct","count_wins","count_draws",
                          "count_losses","count_all")]

colnames(stus) <- c("Win percentage","Draw percentage","Loss percentage","Win count",
                         "Draw count","Loss count","Total games")

stus <- select(stus,c("Total games","Win count","Draw count","Loss count","Win percentage","Draw percentage","Loss percentage"))

kable(stus)

```

Now I have some factors, it's worth exploring the relationship with the result. Let's start with ELO rating. Of course, a game involves two teams; rather than considering the rank of one team it will be better to consider the ratio of ratings between the teams.



```{r ggplot2,echo=FALSE}
g3b <- ggplot(data=wc_results4,aes(x=result,y=rating_diff_percent)) + geom_boxplot()
g3b <- g3b + xlab("game result")+ ylab("Ratio of team differences") +ggtitle("Figure one: Box plot distribution of ELO rating based on team win")
g3b

```

Encouragingly, there does appear to be some correlation between the ratio of differences and the result of the game.

Other factors may be worth considering in the modelling as well. Firstly, it may be worth considering the contiental affiliation of the teams. The below table lists win rates by continent;

<b>Table two; results by continental affiliation</b>
```{r continent,echo=FALSE,message=FALSE,warning=FALSE}

cont_stus1 <- wc_results4 %>% group_by(conf_team_one) %>% summarise(count_all=n())

cont_stus2 <- wc_results4 %>% group_by(conf_team_one) %>%filter(team_one_win==1) %>% summarise(count_wins=n())
cont_stus3 <- wc_results4 %>% group_by(conf_team_one) %>%filter(draw==1) %>% summarise(count_draws=n())

cont_stus <-  left_join(cont_stus1,cont_stus2) %>%  inner_join (cont_stus3) %>% replace_na(list(count_wins=0)) %>%
    mutate(win_pct = count_wins/count_all,draw_pct = count_draws/count_all,loss_pct = 1-win_pct-draw_pct)

continent <- as.data.frame(c("Asia","Africa","North America","South America","Oceania","Europe"))
continent$conf_team_one <- c("AFC","CAF","CONCACAF","CONMEBOL","OFC","UEFA")
colnames(continent) <- c("Continent","conf_team_one")
cont_stus <- inner_join(cont_stus,continent)
cont_stus$count_losses <- with(cont_stus,count_all-count_draws-count_wins)
cont_stus$win_pct <- round(cont_stus$win_pct,3)
cont_stus$draw_pct <- round(cont_stus$draw_pct,3)
cont_stus$loss_pct <- round(cont_stus$loss_pct,3)
cont_stus <- cont_stus[,c("conf_team_one","Continent","win_pct","draw_pct","loss_pct","count_wins","count_draws",
                          "count_losses","count_all")]

colnames(cont_stus) <- c("Conference","Continent","Win percentage","Draw percentage","Loss percentage","Win count",
                         "Draw count","Loss count","Total games")


kable(cont_stus)

```

Exploring the relationship between ELO rating and continental affiliation reveals some interesting trends. The below box plots consider the distribution of ELO rating differences by the result of the game, and continental affiliation. All continents seem to show a broadly similar trend, in which teams with a higher ELO rating are more likely to win.

```{r ggplot3,echo=FALSE}
g3d <- ggplot(data=wc_results4,aes(x=result,y=rating_diff_percent)) + geom_boxplot()
g3d <- g3d + xlab("game result")+ ylab("Ratio of team differences") +ggtitle("Figure two; Box plot  of ELO rating based on team win, split by continent")
g3d <- g3d + facet_grid(.~conf_team_one)
g3d

```


Another factor to consider could be the location of the tournament, relative to the location of the teams. E.g. if the tournament is held in Europe then we might see European teams perform better due to the smaller distance of travel. 

```{r ggplot4,echo=FALSE}
wc_results4$home_stus <- ""
wc_results4$home_stus[wc_results4$home_cont_one==1&wc_results4$home_cont_two==1] <-"both home"

wc_results4$home_stus[wc_results4$home_cont_one==1&wc_results4$home_cont_two==0] <- "home v away"
wc_results4$home_stus[wc_results4$home_cont_one==0&wc_results4$home_cont_two==1] <-"away v home"
wc_results4$home_stus[wc_results4$home_cont_one==0&wc_results4$home_cont_two==0]<- "away v away"

g3d <- ggplot(data=wc_results4,aes(x=result,y=rating_diff_percent)) + geom_boxplot()
g3d <- g3d + xlab("game result")+ ylab("Ratio of team differences") +ggtitle("Figure three; Box plot of ELO rating based on team win, split by location")
g3d <- g3d + facet_grid(.~home_stus)
g3d

```


###Modelling approach
Ultimately we want a model that will take as an input factors relating to the two teams (ELO ratings, continental affilation etc) and produce as an output the probability of team one winning, team two winning, and a draw.

The modelling approach I have taken is to develop a binomal logistic regression model with "team one win" as the outcome variable. Once we have the model we can then apply it to team one and team two to get an estimate of the probabilities of each of the teams winning. The probability of a draw can then be derived via 1 minus the probability of each team winning.



```{r model,echo=FALSE,warning=FALSE,message=FALSE}
library(caret)
library(DT)
wc_results4$home_cont_two <- as.factor(wc_results4$home_cont_two)
set.seed(101)
train_data <- createDataPartition(wc_results4$team_one_win,p=0.8,list=FALSE)
wc_train <-wc_results4[train_data,]
wc_test <-wc_results4[-train_data,]

wc_glm_conf4b <- glm(data=wc_train,team_one_win~rating_diff_percent+home_cont_two,
                     family=binomial(link="logit"))

wc_glm_conf4b_predict_test <- ifelse(predict(wc_glm_conf4b,newdata=wc_test)>0,1,0)
wc_glm_conf4b_predict_tab_test <- table(wc_test$team_one_win,wc_glm_conf4b_predict_test)
wc_cm <- confusionMatrix(wc_glm_conf4b_predict_tab_test)

wc_cm_accuracy <- round(wc_cm$overall[1],3)
wc_cm_accuracy_lower <- round(wc_cm$overall[3],3)
wc_cm_accuracy_upper <- round(wc_cm$overall[4],3)

wc_cm_accuracy2 <- wc_cm_accuracy*100
```

The final model that I settled on uses the rating, and a factor based on whether the opposing team was playing in their home continent. Applying this model to a hold-out sample resulted in a `r wc_cm_accuracy` accuracy in predicting a win, with 95% confidence that the true model accuracy lies between `r wc_cm_accuracy_lower` and `r wc_cm_accuracy_upper`. In other words, the model is able to predict an accurate result `r wc_cm_accuracy2`% of the time. 

This is an acceptable result for our modelling, without being incredibly accurate; since circa 40% of games end in a win for a specific team, a coin-flip model with heads for a win and tails for a loss would be accurate 40% of the time. Nevertheless, this model should be sufficient for the purposes of our simulations.

###Monte-carlo simulation
Monte-carlo simulation involves iterating a process with random factors in order to obtain a distribution of possible results (for more information, please see <a href="http://en.wikipedia.org/wiki/Monte_Carlo_method">this wikipedia link</a>. Now that we have a model that can predict the result of a game, we can use this to simulate the entire world cup.

The method that I have used to do this is as follows. Teams have already been seperated into pools based on <a href="http://en.wikipedia.org/wiki/2018_FIFA_World_Cup">the world cup draw</a>. For the group stage, I apply the model for each team, for each game. I then apply a random number between 0 and 1 to each game; if this number is less than the estimate for team one, the game is a win for that team; if it is larger than the win estimate but less than the draw estimate, then the game is a draw; otherwise the game is a win for team two.

The below table is an example of this.

<b>Table three; example of group stage modelling</b>
```{r group,echo=FALSE}

games <- read.csv("C:/Users/pc/Documents/Data science/World cup 2018/group game preds.csv")

games2 <- games[c(1:4),]
games3 <- select(games2,c("team_one","rank_team_one","team_two","rank_team_two","team_one_win_pred",
                         "draw_pred","team_two_win_pred","rngs"))

games3$result <- ""
games3$result[games2$win_one==1] <- paste0(games2$team_one[games2$win_one==1]," win")

games3$result[games2$win_two==1] <- paste0(games2$team_two[games2$win_two==1]," win")

games3$result[games2$draw==1] <- paste0("Draw")
 games3$team_one_win_pred <- round(games3$team_one_win_pred,3 )
 games3$draw_pred <- round(games3$draw_pred,3 )
 games3$team_two_win_pred <- round(games3$team_two_win_pred,3 )
 games3$rngs <- round(games3$rngs,3 )
 colnames(games3) <- c("Team one","Rank team one","Team two","Rank team two","Team one win likelihood",
                       "Draw likelihood","Team two win likelihood","Random number","Result based on random number")

kable(games3)
```

Using a random number generator I can then determine a result for each game. Once we have done this I can calculate the results of the group stage. In the event of a tie during the group stage, I have used a second random number to determine the ranking. 

Once this has taken place, I can then simulate the knock-out stages. For the knock-out stages I have used the same method as above to determine the likelihood of each winner. In the event of a draw, I have used a coin-flip to determine the result. This could weight slightly towards the less favoured team, but acts as a simplifying assumption in part. 

We can then iterate this process a number of times; the results of this are then an approximation of how we might expect the result to play out.

###Results

The below table lists how far each team progressed in the world cup, based on 1,000 iterations of the simulation described above.

<b>Table four; modelling results</b>
```{r results,echo=FALSE,warning=FALSE,message=FALSE}

library(dplyr)

library(rvest)
library(tidyverse)


assoc <- c("AFC","CAF","CONCACAF","CONMEBOL","OFC","UEFA")
##initialise the model
url <- paste0("http://www.international-football.net/countries")
test_results <-read_html(url)
conf_x <- lapply(assoc,function(x){
    scrape <- paste0("#",x," div")
    conf_data1 <- html_nodes(test_results,scrape)
    conf_data2 <- html_text(conf_data1)
    
    conf_data  <- unique(conf_data2[conf_data2!=""])
    conf_data  <- as.data.frame(conf_data)
    conf_data$assoc <-x
    return(conf_data)
})

conferences <- bind_rows(conf_x)
colnames(conferences) <-c("country","conference")

logit2prob <- function(x){exp(x)/(1+exp(x))}
groups <- list(0)

groups[[1]] <- c("Russia","Saudi Arabia","Egypt","Uruguay")
groups[[2]] <- c("Portugal","Spain","Morocco","Iran")
groups[[3]] <- c("France","Australia","Peru","Denmark")
groups[[4]] <- c("Argentina","Iceland","Croatia","Nigeria")
groups[[5]] <- c("Brazil","Switzerland","Costa Rica","Serbia")
groups[[6]] <- c("Germany","Mexico","Sweden","South Korea")
groups[[7]] <- c("Belgium","Panama","Tunisia","England")
groups[[8]] <- c("Poland","Senegal","Colombia","Japan")
##reload our function to read the ELO ratings at a certain point in time

ranking_date <- function(year_rank,month_rank,day_rank){
    url <- paste0("http://www.international-football.net/elo-ratings-table?year=",year_rank,"&month=",month_rank,"&day=",day_rank)
    test_2014 <-read_html(url)
    test_20142 <- html_nodes(test_2014,"#contents td")
    test_20143 <- html_text(test_20142)
    exclude_index <- c(0:300)*3+1
    country_names_index <- c(0:300)*3+2
    country_ranks_index <- c(0:300)*3+3
    
    country_names_x <- (test_20143[country_names_index])
    country_names <-as.data.frame(country_names_x[is.na(country_names_x)==FALSE])
    
    country_ranks_x <- (test_20143[country_ranks_index])
    country_ranks <-as.data.frame(as.numeric(country_ranks_x[is.na(country_ranks_x)==FALSE]))
    
    country_name_ranks <- cbind(country_names,country_ranks)
    colnames(country_name_ranks) <-c("country","rank")
    country_name_ranks <- left_join(country_name_ranks,conferences)
    country_name_ranks$year <- year_rank
    return(country_name_ranks)
}

ranks <- ranking_date(2018,05,20)
ranks <- dplyr::select(ranks,-year)
ranks$home_cont_flag <- ifelse(ranks$conference=="UEFA",1,0)
groups_with_rank <- lapply(groups,function(x){
    x1 <- as.data.frame(x)
    colnames(x1) <- c("country")
    x2 <- inner_join(x1,ranks)
    return(x2)})

##ok, now I want to generate for each group a set of games, and then
##we can apply the model to these games

group_games <- lapply(groups_with_rank,function(x){
        games_temp <- as.data.frame((matrix(nrow=6,ncol=6)))
        for (i in (1:4)){
        games_temp[,i]   <- c(x[1,i],x[1,i],x[1,i],x[2,i],x[2,i],x[3,i])
        games_temp[,i+4] <- c(x[2,i],x[3,i],x[4,i],x[3,i],x[4,i],x[4,i])
        }
        colnames(games_temp) <- c("team_one","rank_team_one","conf_team_one","home_cont_one",
                                  "team_two","rank_team_two","conf_team_two","home_cont_two")
        games_temp$rating_diff_percent_one <- games_temp$rank_team_one / games_temp$rank_team_two
        games_temp$rating_diff_percent_two <- games_temp$rank_team_two / games_temp$rank_team_one
        
        return(games_temp)
        }
        )

##some further manipulation and then apply the model
group_games_with_pred <- lapply(group_games,function(x){
    team_one_pred_temp <- select(x,conf_team_one,home_cont_one,home_cont_two,rating_diff_percent_one)
    colnames(team_one_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
    team_one_pred_temp$home_cont_two <- as.factor(team_one_pred_temp$home_cont_two)
    team_one_pred_temp$home_cont_one <- as.factor(team_one_pred_temp$home_cont_one)
    team_one_win_pred <- predict(wc_glm_conf4b,newdata=team_one_pred_temp)
    
    team_two_pred_temp <- select(x,conf_team_two,home_cont_two,home_cont_one,rating_diff_percent_two)
    colnames(team_two_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
    team_two_pred_temp$home_cont_two <- as.factor(team_two_pred_temp$home_cont_two)
    team_two_pred_temp$home_cont_one <- as.factor(team_two_pred_temp$home_cont_one)
    
    team_two_win_pred <- predict(wc_glm_conf4b,newdata=team_two_pred_temp)
    x$team_one_win_pred <- logit2prob(team_one_win_pred)
    x$team_two_win_pred <- logit2prob(team_two_win_pred)
    x$draw_pred <- 1-x$team_one_win_pred - x$team_two_win_pred 
    x$draw_pred[x$draw_pred<0]  <- 0
    ##add some return statistics
    x$team_one_win_return = 1/x$team_one_win_pred
    x$team_two_win_return = 1/x$team_two_win_pred
    x$draw_return = 1/x$draw_pred
    return(x)
})
##ok, so now we have a list of each group game, and the likelihood of each game taking place
##We can then use this to simulate the results.
games <- bind_rows(group_games_with_pred)

iter <- 1000 ##number of iterations

wc_quarterfinals <- list(0)
group_winners <- list(0)
group_runners_up <- list(0)
for (i in c(1:iter)){
    set.seed(i)
    games$rngs <- runif(n=48)

    games$win_one <- 0
    games$draw <- 0
    games$win_two <- 0
    
    ##determine the result of each game
    for(j in c(1:48)){
    games$win_one[j] <- ifelse(games$rngs[j] < games$team_one_win_pred[j],1,0)
    games$draw[j] <- ifelse(games$rngs[j] > games$team_one_win_pred[j]& 
                             games$rngs[j] < (games$team_one_win_pred[j] + games$draw_pred[j]) ,1,0)
    games$win_two[j] <- ifelse(games$win_one[j] ==0 & games$draw[j]==0,1,0)
    }
    ##determine number of team_wins
    team_wins <- games %>% group_by(team_one) %>% summarise(win_ones=sum(win_one),draw_ones=sum(draw))
    colnames(team_wins)[1] <- c("country")
    team_wins2 <- games %>% group_by(team_two) %>% summarise(win_twos=sum(win_two),draw_twos=sum(draw))
    colnames(team_wins2)[1] <- c("country")
     countries <- as.data.frame(unique(c(as.character(team_wins$country),as.character(team_wins2$country))))
     colnames(countries) <- c("country")
    countries2 <- left_join(countries,team_wins) %>% left_join(team_wins2) 
    countries2[is.na(countries2)] <-0
    countries3 <- mutate(countries2,wins=win_ones+win_twos,draws=draw_ones+draw_twos,losses=3-wins-draws)
                                                         
    team_wins_out <- countries3[,c("country","wins","draws","losses")]
    ##create a new list with the rankings
    set.seed(i+1000) 
        groups_with_res <- lapply(groups_with_rank,function(x) {
        groups_temp <- left_join(x,team_wins_out)
        groups_temp$points <- 3*groups_temp$wins + groups_temp$draws

        groups_temp$rand <- runif(4) 
        groups_temp2 <- arrange(groups_temp,desc(points),rand)
        return(groups_temp2)
    })
        r16_games <- list(0)
    #ok, now we have the group games. Lets set up the round of 16 games.
        r16_games_one <- c(1,3,5,7,2,4,6,8)
        r16_games_two <- c(2,4,6,8,1,3,5,7)
        r16_games_one_rank <- c(1,1,1,1,1,1,1,1)
        r16_games_two_rank <- c(2,2,2,2,2,2,2,2)
        

        for(j in (1:8)){
        t1 <- r16_games_one[j]
        t2 <- r16_games_two[j]
        r1 <- r16_games_one_rank[j]
        r2 <- r16_games_two_rank[j]
        t1_data <- groups_with_res[[ t1 ]][r1,c("country","rank","conference","home_cont_flag")]
        t2_data <- groups_with_res[[ t2 ]][r2,c("country","rank","conference","home_cont_flag")]
        r16_game_temp <- cbind(t1_data,t2_data)
        colnames(r16_game_temp) <- c("team_one","rank_team_one","conf_team_one","home_cont_one",
                                  "team_two","rank_team_two","conf_team_two","home_cont_two")
        r16_game_temp$rating_diff_percent_one <- r16_game_temp$rank_team_one / r16_game_temp$rank_team_two
        r16_game_temp$rating_diff_percent_two <- r16_game_temp$rank_team_two / r16_game_temp$rank_team_one
        
        r16_games[[j]] <- r16_game_temp
        }
     
##determine the result of each r16 game
        
        r16_games_with_pred <- lapply(r16_games,function(x){
            
            team_one_pred_temp <- select(x,conf_team_one,home_cont_one,home_cont_two,rating_diff_percent_one)
            colnames(team_one_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
            team_one_pred_temp$home_cont_two <- as.factor(team_one_pred_temp$home_cont_two)
            team_one_pred_temp$home_cont_one <- as.factor(team_one_pred_temp$home_cont_one)
            
            team_one_win_pred <- predict(wc_glm_conf4b,newdata=team_one_pred_temp)
            
            team_two_pred_temp <- select(x,conf_team_two,home_cont_two,home_cont_one,rating_diff_percent_two)
            colnames(team_two_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
            team_two_pred_temp$home_cont_two <- as.factor(team_two_pred_temp$home_cont_two)
            team_two_pred_temp$home_cont_one <- as.factor(team_two_pred_temp$home_cont_one)
                    
            team_two_win_pred <- predict(wc_glm_conf4b,newdata=team_two_pred_temp)
            x$team_one_win_pred <- logit2prob(team_one_win_pred)
            x$team_two_win_pred <- logit2prob(team_two_win_pred)
            x$draw_pred <- 1-x$team_one_win_pred - x$team_two_win_pred 
            x$draw_pred[x$draw_pred<0]  <- 0
            return(x)
        })
        r16_game_table <- bind_rows(r16_games_with_pred)
        set.seed(i+3000)
        r16_game_table$rngs <- runif(8)
        set.seed(i+30000)
        r16_game_table$rngs2 <- runif(8) ##this one will be used if any game ends in a draw 
        
        r16_game_table$win_one <- 0
        r16_game_table$draw <- 0
        r16_game_table$win_two <- 0
        r16_game_table$advance_team <- ""
        r16_game_table$advance_conf <- ""
        r16_game_table$advance_home_cont <- 0
        r16_game_table$advance_rank_team <- 0
        ##determine the result of each game
        for(j in c(1:8)){
            r16_game_table$win_one[j] <- ifelse(r16_game_table$rngs[j] < r16_game_table$team_one_win_pred[j],1,0)
            r16_game_table$draw[j] <- ifelse(r16_game_table$rngs[j] > r16_game_table$team_one_win_pred[j]& 
                                                 r16_game_table$rngs[j] < (r16_game_table$team_one_win_pred[j] + r16_game_table$draw_pred[j]),1,0)
            r16_game_table$win_two[j] <- ifelse(r16_game_table$win_one[j] ==0 & r16_game_table$draw[j]==0,1,0)
        
            if (r16_game_table$draw[j]==1 & r16_game_table$rngs2[j] < 0.5) {r16_game_table$win_one[j] <- 1}
            else if(r16_game_table$draw[j]==1 & r16_game_table$rngs2[j] > 0.5) {r16_game_table$win_two[j] <- 1}
            
            ##who advances?
            if (r16_game_table$win_one[j]==1 ){
                r16_game_table$advance_team[j] <- r16_game_table$team_one[j]
                r16_game_table$advance_conf[j] <- r16_game_table$conf_team_one[j]
                r16_game_table$advance_home_cont[j] <- r16_game_table$home_cont_one[j]
                r16_game_table$advance_rank_team[j] <- r16_game_table$rank_team_one[j]
            }
            else {
                r16_game_table$advance_team[j] <- r16_game_table$team_two[j]
                r16_game_table$advance_conf[j] <- r16_game_table$conf_team_two[j]
                r16_game_table$advance_home_cont[j] <- r16_game_table$home_cont_two[j]
                r16_game_table$advance_rank_team[j] <- r16_game_table$rank_team_two[j]
            }
         }
        ##ok, so now we need to do the same thing for the round of 8
        
        r8_games <- list(0)
        for(j in (1:4)){
            t1_data <-  r16_game_table[j*2-1,c("advance_team","advance_rank_team","advance_conf","advance_home_cont")]
            t2_data <-  r16_game_table[j*2,c("advance_team","advance_rank_team","advance_conf","advance_home_cont")]
            r8_game_temp <- cbind(t1_data,t2_data)
            colnames(r8_game_temp) <- c("team_one","rank_team_one","conf_team_one","home_cont_one",
                                         "team_two","rank_team_two","conf_team_two","home_cont_two")
            r8_game_temp$rating_diff_percent_one <- r8_game_temp$rank_team_one / r8_game_temp$rank_team_two
            r8_game_temp$rating_diff_percent_two <- r8_game_temp$rank_team_two / r8_game_temp$rank_team_one
            
            r8_games[[j]] <- r8_game_temp
        }
        
        r8_games_with_pred <- lapply(r8_games,function(x){
            
            team_one_pred_temp <- select(x,conf_team_one,home_cont_one,home_cont_two,rating_diff_percent_one)
            colnames(team_one_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
            team_one_pred_temp$home_cont_two <- as.factor(team_one_pred_temp$home_cont_two)
            team_one_pred_temp$home_cont_one <- as.factor(team_one_pred_temp$home_cont_one)
            
            team_one_win_pred <- predict(wc_glm_conf4b,newdata=team_one_pred_temp)
            
            team_two_pred_temp <- select(x,conf_team_two,home_cont_two,home_cont_one,rating_diff_percent_two)
            colnames(team_two_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
            team_two_pred_temp$home_cont_two <- as.factor(team_two_pred_temp$home_cont_two)
            team_two_pred_temp$home_cont_one <- as.factor(team_two_pred_temp$home_cont_one)
            
            team_two_win_pred <- predict(wc_glm_conf4b,newdata=team_two_pred_temp)
            x$team_one_win_pred <- logit2prob(team_one_win_pred)
            x$team_two_win_pred <- logit2prob(team_two_win_pred)
            x$draw_pred <- 1-x$team_one_win_pred - x$team_two_win_pred 
            x$draw_pred[x$draw_pred<0]  <- 0
            return(x)
        })
        

        r8_game_table <- bind_rows(r8_games_with_pred)
        set.seed(i+5000)
        r8_game_table$rngs <- runif(4)
        set.seed(i+50000)
        r8_game_table$rngs2 <- runif(4) ##this one will be used if any game ends in a draw 
        
        r8_game_table$win_one <- 0
        r8_game_table$draw <- 0
        r8_game_table$win_two <- 0
        r8_game_table$advance_team <- ""
        r8_game_table$advance_conf <- ""
        r8_game_table$advance_home_cont <- 0
        r8_game_table$advance_rank_team <- 0
        ##determine the result of each game
        for(j in c(1:4)){
            r8_game_table$win_one[j] <- ifelse(r8_game_table$rngs[j] < r8_game_table$team_one_win_pred[j],1,0)
            r8_game_table$draw[j] <- ifelse(r8_game_table$rngs[j] > r8_game_table$team_one_win_pred[j]& 
                                                 r8_game_table$rngs[j] < (r8_game_table$team_one_win_pred[j] + r8_game_table$draw_pred[j]),1,0)
            r8_game_table$win_two[j] <- ifelse(r8_game_table$win_one[j] ==0 & r8_game_table$draw[j]==0,1,0)
            
            if (r8_game_table$draw[j]==1 & r8_game_table$rngs2[j] < 0.5) {r8_game_table$win_one[j] <- 1}
            else if(r8_game_table$draw[j]==1 & r8_game_table$rngs2[j] > 0.5) {r8_game_table$win_two[j] <- 1}
            
            ##who advances?
            if (r8_game_table$win_one[j]==1 ){
                r8_game_table$advance_team[j] <- r8_game_table$team_one[j]
                r8_game_table$advance_conf[j] <- r8_game_table$conf_team_one[j]
                r8_game_table$advance_home_cont[j] <- r8_game_table$home_cont_one[j]
                r8_game_table$advance_rank_team[j] <- r8_game_table$rank_team_one[j]
            }
            else {
                r8_game_table$advance_team[j] <- r8_game_table$team_two[j]
                r8_game_table$advance_conf[j] <- r8_game_table$conf_team_two[j]
                r8_game_table$advance_home_cont[j] <- r8_game_table$home_cont_two[j]
                r8_game_table$advance_rank_team[j] <- r8_game_table$rank_team_two[j]
            }
        }
        ##ok, so now we need to do the same thing for the round of 4
        
        r4_games <- list(0)
        for(j in (1:2)){
            t1_data <-  r8_game_table[j*2-1,c("advance_team","advance_rank_team","advance_conf","advance_home_cont")]
            t2_data <-  r8_game_table[j*2,c("advance_team","advance_rank_team","advance_conf","advance_home_cont")]
            r4_game_temp <- cbind(t1_data,t2_data)
            colnames(r4_game_temp) <- c("team_one","rank_team_one","conf_team_one","home_cont_one",
                                        "team_two","rank_team_two","conf_team_two","home_cont_two")
            r4_game_temp$rating_diff_percent_one <- r4_game_temp$rank_team_one / r4_game_temp$rank_team_two
            r4_game_temp$rating_diff_percent_two <- r4_game_temp$rank_team_two / r4_game_temp$rank_team_one
            
            r4_games[[j]] <- r4_game_temp
        }
        
        r4_games_with_pred <- lapply(r4_games,function(x){
            
            team_one_pred_temp <- select(x,conf_team_one,home_cont_one,home_cont_two,rating_diff_percent_one)
            colnames(team_one_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
            team_one_pred_temp$home_cont_two <- as.factor(team_one_pred_temp$home_cont_two)
            team_one_pred_temp$home_cont_one <- as.factor(team_one_pred_temp$home_cont_one)
            
            team_one_win_pred <- predict(wc_glm_conf4b,newdata=team_one_pred_temp)
            
            team_two_pred_temp <- select(x,conf_team_two,home_cont_two,home_cont_one,rating_diff_percent_two)
            colnames(team_two_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
            team_two_pred_temp$home_cont_two <- as.factor(team_two_pred_temp$home_cont_two)
            team_two_pred_temp$home_cont_one <- as.factor(team_two_pred_temp$home_cont_one)
            
            team_two_win_pred <- predict(wc_glm_conf4b,newdata=team_two_pred_temp)
            
            x$team_one_win_pred <- logit2prob(team_one_win_pred)
            x$team_two_win_pred <- logit2prob(team_two_win_pred)
            x$draw_pred <- 1-x$team_one_win_pred - x$team_two_win_pred 
            x$draw_pred[x$draw_pred<0]  <- 0
            return(x)
        })
        
        
        r4_game_table <- bind_rows(r4_games_with_pred)
        set.seed(i+6000)
        r4_game_table$rngs <- runif(2)
        set.seed(i+60000)
        r4_game_table$rngs2 <- runif(2) ##this one will be used if any game ends in a draw 
        
        r4_game_table$win_one <- 0
        r4_game_table$draw <- 0
        r4_game_table$win_two <- 0
        r4_game_table$advance_team <- ""
        r4_game_table$advance_conf <- ""
        r4_game_table$advance_home_cont <- 0
        r4_game_table$advance_rank_team <- 0
        ##determine the result of each game
        for(j in c(1:2)){
            r4_game_table$win_one[j] <- ifelse(r4_game_table$rngs[j] < r4_game_table$team_one_win_pred[j],1,0)
            r4_game_table$draw[j] <- ifelse(r4_game_table$rngs[j] > r4_game_table$team_one_win_pred[j]& 
                                                r4_game_table$rngs[j] < (r4_game_table$team_one_win_pred[j] + r4_game_table$draw_pred[j]),1,0)
            r4_game_table$win_two[j] <- ifelse(r4_game_table$win_one[j] ==0 & r4_game_table$draw[j]==0,1,0)
            
            if (r4_game_table$draw[j]==1 & r4_game_table$rngs2[j] < 0.5) {r4_game_table$win_one[j] <- 1}
            else if(r4_game_table$draw[j]==1 & r4_game_table$rngs2[j] > 0.5) {r4_game_table$win_two[j] <- 1}
            
            ##who advances?
            if (r4_game_table$win_one[j]==1 ){
                r4_game_table$advance_team[j] <- r4_game_table$team_one[j]
                r4_game_table$advance_conf[j] <- r4_game_table$conf_team_one[j]
                r4_game_table$advance_home_cont[j] <- r4_game_table$home_cont_one[j]
                r4_game_table$advance_rank_team[j] <- r4_game_table$rank_team_one[j]
            }
            else {
                r4_game_table$advance_team[j] <- r4_game_table$team_two[j]
                r4_game_table$advance_conf[j] <- r4_game_table$conf_team_two[j]
                r4_game_table$advance_home_cont[j] <- r4_game_table$home_cont_two[j]
                r4_game_table$advance_rank_team[j] <- r4_game_table$rank_team_two[j]
            }
        }  
        
        
        ##ok, now for the final
t1_data <-  r4_game_table[1,c("advance_team","advance_rank_team","advance_conf","advance_home_cont")]
t2_data <-  r4_game_table[2,c("advance_team","advance_rank_team","advance_conf","advance_home_cont")]
r2_game_table <- cbind(t1_data,t2_data)
colnames(r2_game_table) <- c("team_one","rank_team_one","conf_team_one","home_cont_one",
                            "team_two","rank_team_two","conf_team_two","home_cont_two")
r2_game_table$rating_diff_percent_one <- r2_game_table$rank_team_one / r2_game_table$rank_team_two
r2_game_table$rating_diff_percent_two <- r2_game_table$rank_team_two / r2_game_table$rank_team_one
        
team_one_pred_temp <- select(r2_game_table,conf_team_one,home_cont_one,home_cont_two,rating_diff_percent_one)
colnames(team_one_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
team_one_pred_temp$home_cont_two <- as.factor(team_one_pred_temp$home_cont_two)
team_one_pred_temp$home_cont_one <- as.factor(team_one_pred_temp$home_cont_one)

team_one_win_pred <- predict(wc_glm_conf4b,newdata=team_one_pred_temp)
        
team_two_pred_temp <- select(r2_game_table,conf_team_two,home_cont_two,home_cont_one,rating_diff_percent_two)
colnames(team_two_pred_temp) <- c("conf_team_one","home_cont_one","home_cont_two","rating_diff_percent")
team_two_pred_temp$home_cont_two <- as.factor(team_two_pred_temp$home_cont_two)
team_two_pred_temp$home_cont_one <- as.factor(team_two_pred_temp$home_cont_one)
team_two_win_pred <- predict(wc_glm_conf4b,newdata=team_two_pred_temp)

r2_game_table$team_one_win_pred <- logit2prob(team_one_win_pred)
r2_game_table$team_two_win_pred <- logit2prob(team_two_win_pred)
r2_game_table$draw_pred <- 1-r2_game_table$team_one_win_pred - r2_game_table$team_two_win_pred 
r2_game_table$draw_pred[r2_game_table$draw_pred<0]  <- 0

set.seed(i+7000)
r2_game_table$rngs <- runif(1)
set.seed(i+70000)
r2_game_table$rngs2 <- runif(1) ##this one will be used if any game ends in a draw 


r2_game_table$win_one <- 0
r2_game_table$draw <- 0
r2_game_table$win_two <- 0
r2_game_table$advance_team <- ""

r2_game_table$win_one <- ifelse(r2_game_table$rngs < r2_game_table$team_one_win_pred,1,0)
r2_game_table$draw <- ifelse(r2_game_table$rngs > r2_game_table$team_one_win_pred& 
                                    r2_game_table$rngs < (r2_game_table$team_one_win_pred + r2_game_table$draw_pred),1,0)
r2_game_table$win_two <- ifelse(r2_game_table$win_one ==0 & r2_game_table$draw==0,1,0)

if (r2_game_table$draw==1 & r2_game_table$rngs2 < 0.5) {r2_game_table$win_one <- 1} else
    if(r2_game_table$draw==1 & r2_game_table$rngs2 > 0.5) {r2_game_table$win_two <- 1}

##who advances?
if (r2_game_table$win_one==1 ){
    r2_game_table$advance_team <- r2_game_table$team_one
} else {
    r2_game_table$advance_team <- r2_game_table$team_two

}
##final rankings
country_final_rank <- ""
country_final_rank[1] <- r2_game_table$advance_team
country_final_rank[2] <- ifelse(r2_game_table$win_one==1,r2_game_table$team_two,r2_game_table$team_one)

country_final_rank[3] <- ifelse(r4_game_table$win_one[1]==1,r4_game_table$team_two[1],r4_game_table$team_one[1])
country_final_rank[4] <- ifelse(r4_game_table$win_one[2]==1,r4_game_table$team_two[2],r4_game_table$team_one[2])

country_final_rank[5] <- ifelse(r8_game_table$win_one[1]==1,r8_game_table$team_two[1],r8_game_table$team_one[1])
country_final_rank[6] <- ifelse(r8_game_table$win_one[2]==1,r8_game_table$team_two[2],r8_game_table$team_one[2])
country_final_rank[7] <- ifelse(r8_game_table$win_one[3]==1,r8_game_table$team_two[3],r8_game_table$team_one[3])
country_final_rank[8] <- ifelse(r8_game_table$win_one[4]==1,r8_game_table$team_two[4],r8_game_table$team_one[4])

group_winners_temp <- lapply(groups_with_res,function(x){return(x$country[1])})
group_winners_temp2 <- unlist(group_winners_temp)

group_rups_temp <- lapply(groups_with_res,function(x){return(x$country[2])})
group_rups_temp2 <- unlist(group_rups_temp)


country_final_rank <- as.data.frame(cbind(country_final_rank,c(1,2,4,4,8,8,8,8)))
colnames(country_final_rank) <- c("country","rank")
wc_quarterfinals[[i]] <- country_final_rank
group_winners[[i]] <- group_winners_temp2
group_runners_up[[i]] <- group_rups_temp2
}
wc_quarterfinals_out <- bind_rows(wc_quarterfinals)
wc_winners <- wc_quarterfinals_out %>%filter(rank ==1) %>% group_by(country) %>% summarise(wins=n(),
                                                                                          percent=n()/iter,
                                                                                          return=1/percent) %>%
                                                                arrange(desc(percent))

wc_finalists <- wc_quarterfinals_out %>%filter(rank %in% c(1,2)) %>% group_by(country) %>% summarise(wins=n(),
                                                                                           percent=n()/iter,
                                                                                           return=1/percent) %>%
    arrange(desc(percent))

wc_semis <- wc_quarterfinals_out %>%filter(rank %in% c(1,2,3,4)) %>% group_by(country) %>% summarise(wins=n(),
                                                                                                     percent=n()/iter,
                                                                                                     return=1/percent) %>%
    arrange(desc(percent))

wc_qfs <- wc_quarterfinals_out %>% group_by(country) %>% summarise(qfs=n(),
                                                                                           percent=n()/iter) %>%
    arrange(desc(percent))


group_winners2 <- unlist(group_winners)
group_win_count <- arrange(as.data.frame(table(group_winners2)),desc(Freq)) %>% mutate(win_pct = Freq/1000,
                                                                                return=(1/win_pct))

 
 colnames(group_win_count) <- c("country","group_wins","group_win_percent","group_win_return")
 
colnames(wc_qfs) <- c("country","qfs","qf_percent")
wc_qfs$qf_return <- 1/wc_qfs$qf_percent
colnames(wc_semis) <- c("country","semis","semi_percent","semi_return")
colnames(wc_finalists) <- c("country","finals","final_percent","final_return")

colnames(wc_winners) <- c("country","wins","win_percent","win_return")

table_of_results <- group_win_count %>% left_join(wc_qfs,by="country") %>% left_join(wc_semis,by="country") %>%
                    left_join(wc_finalists,by="country") %>% left_join(wc_winners,by="country")

table_of_results[is.na(table_of_results)] <- 0
table_of_results2 <- select(table_of_results,contains("percent"))
table_of_results2$country <- table_of_results$country


##add the group the team starts in

team_groups <- c("Russia","Saudi Arabia","Egypt","Uruguay",
                 "Portugal","Spain","Morocco","Iran",
                 "France","Australia","Peru","Denmark",
                 "Argentina","Iceland","Croatia","Nigeria",
                 "Brazil","Switzerland","Costa Rica","Serbia",
                 "Germany","Mexico","Sweden","South Korea",
                 "Belgium","Panama","Tunisia","England",
                 "Poland","Senegal","Colombia","Japan")
team_group_names <-c(rep("A",4),rep("B",4),rep("C",4),rep("D",4),rep("E",4),rep("F",4),
                    rep("G",4),rep("H",4))

team_groups2 <- as.data.frame(cbind(team_groups,team_group_names)) 
colnames(team_groups2) <- c("country","group")
table_of_results2a <- inner_join(table_of_results2,team_groups2)
table_of_results3 <- select(table_of_results2a,country,group,everything()) %>%               arrange(desc(win_percent))

colnames(table_of_results3) <- c("Country","Group","Percent of times team wins group","Percent of times team makes quarter finals",
                                 "Percent of times team makes semis","Percent of times team makes final",
                                 "Percent of times team wins world cup")
datatable(table_of_results3,rownames=FALSE,options=list(pageLength=32,lengthChange=FALSE,
                                                        searching=FALSE,fixedHeader.footer=FALSE))

```

Some interesting narratives present themselves when reviewing this table, and in particular how some teams have markedly different likelihoods of winning their group against winning the world cup. For instance, Poland have a higher likelihood than Portugal than winning their group, but Portgual still have a much higher likelihood of winning the world cup. Recall Poland are in a comparatively weak group but Portugal's group contains Spain.

The most readily available predictions of world cup results come via betting websites. For easy comparison, the below table contains the same information but presented as "decimal odds". This can be interpreted as the winnings made when a bet is placed on that team. 

<b>Table five; modelling results formatted as decimal odds</b>
```{r results2,echo=FALSE,warning=FALSE,message=FALSE}

table_of_results4 <- select(table_of_results3,contains("percent"))
table_of_results4[table_of_results4==0] <- 0.0001
table_of_results4 <- 1/table_of_results4
table_of_results4 <- round(table_of_results4,2)
table_of_results4$country <- table_of_results3$Country
table_of_results4$group <- table_of_results3$Group

table_of_results4 <- select(table_of_results4,country,group,everything())
colnames(table_of_results4) <- c("Country","Group","Decimal odds to win group","Decimal odds to make quarter final",
                                 "Decimal odds to make semis","Decimal odds to make final",
                                 "Decimal odds to win world cup")

datatable(table_of_results4,rownames=FALSE,options=list(pageLength=32,lengthChange=FALSE,
                                                        searching=FALSE,fixedHeader.footer=FALSE))

```


###Links & Further information
For all of this analysis, I have used RStudio. Here is a link to a Github repository with my R scripts. Please be forewarned that the exploratory analysis and modelling stages are quite messy. 

http://github.com/chrishay1/wc2018_pred

I can be contacted at an_aucklander@hotmail.com if you wish to discuss further.
